---
# 设置SSH免密登录
# 使用方法: ansible-playbook setup_ssh.yml --ask-pass

- name: Setup SSH Key-based Authentication
  hosts: all
  gather_facts: no
  
  tasks:
    - name: Test connection with password
      ping:
      ignore_errors: yes
      register: connection_test

    - name: Generate SSH key pair on control node if not exists
      delegate_to: localhost
      run_once: true
      openssh_keypair:
        path: ~/.ssh/id_rsa
        type: rsa
        size: 4096
        state: present
        force: no
      register: ssh_keypair

    - name: Read public key
      delegate_to: localhost
      run_once: true
      slurp:
        src: ~/.ssh/id_rsa.pub
      register: ssh_public_key

    - name: Create .ssh directory on remote hosts
      file:
        path: ~/.ssh
        state: directory
        mode: '0700'

    - name: Copy SSH public key to remote hosts
      authorized_key:
        user: "{{ ansible_user }}"
        key: "{{ ssh_public_key['content'] | b64decode }}"
        state: present

    - name: Test SSH connection without password
      ping:
      register: test_result

    - name: Display success message
      debug:
        msg: "节点 {{ inventory_hostname }} SSH免密登录设置成功！"
