---
# 根据新格式化的磁盘更新配置文件
# 使用方法: ansible-playbook update_config_after_format.yml -e @formatted_disks_map.yml

- name: Update Config After Disk Format
  hosts: all
  gather_facts: no
  any_errors_fatal: false
  ignore_unreachable: yes
  vars:
    curvine_install_dir: /root/dist
    curvine_config_file: "{{ curvine_install_dir }}/conf/curvine-cluster.toml"
  
  tasks:
    - name: Check if this host has formatted disks
      set_fact:
        host_mountpoints: "{{ formatted_disks_map[inventory_hostname] | default([]) }}"
      when: formatted_disks_map is defined

    - name: Skip if no formatted disks
      debug:
        msg: "节点 {{ inventory_hostname }} 没有新格式化的磁盘，跳过配置更新"
      when: host_mountpoints is not defined or host_mountpoints | length == 0

    - name: Display mountpoints for this host
      debug:
        msg: |
          节点 {{ inventory_hostname }}:
          新挂载点: {{ host_mountpoints }}
      when: host_mountpoints is defined and host_mountpoints | length > 0

    - name: Backup config file
      copy:
        src: "{{ curvine_config_file }}"
        dest: "{{ curvine_config_file }}.before_mount_update"
        remote_src: yes
      when: host_mountpoints is defined and host_mountpoints | length > 0

    - name: Update meta_dir for master nodes
      replace:
        path: "{{ curvine_config_file }}"
        regexp: '^(\s*)meta_dir\s*=\s*"([^"]*)"'
        replace: '\1meta_dir = "{{ host_mountpoints[0] }}/\2" | regex_replace("/data/", "/")'
      when: 
        - "'master' in group_names"
        - host_mountpoints is defined 
        - host_mountpoints | length > 0

    - name: Update journal_dir for master nodes
      replace:
        path: "{{ curvine_config_file }}"
        regexp: '^(\s*)journal_dir\s*=\s*"([^"]*)"'
        replace: '\1journal_dir = "{{ host_mountpoints[0] }}/\2" | regex_replace("/data/", "/")'
      when: 
        - "'master' in group_names"
        - host_mountpoints is defined 
        - host_mountpoints | length > 0

    - name: Build data_dir array
      set_fact:
        new_data_dirs: "{{ host_mountpoints | map('regex_replace', '$', '/data') | list }}"
      when: host_mountpoints is defined and host_mountpoints | length > 0

    - name: Update data_dir
      replace:
        path: "{{ curvine_config_file }}"
        regexp: '^(\s*)data_dir\s*=\s*\[.*\]'
        replace: 'data_dir = {{ new_data_dirs | to_json }}'
      when: 
        - host_mountpoints is defined 
        - host_mountpoints | length > 0
        - new_data_dirs is defined

    - name: Read updated config
      shell: |
        echo "=== Master配置 ===" 
        grep -E 'meta_dir|journal_dir|data_dir' {{ curvine_config_file }} || true
      register: updated_config
      when: host_mountpoints is defined and host_mountpoints | length > 0

    - name: Display updated config
      debug:
        msg: |
          节点 {{ inventory_hostname }} 配置已更新:
          {{ updated_config.stdout }}
      when: 
        - host_mountpoints is defined 
        - host_mountpoints | length > 0
        - updated_config is defined

