---
# 卸载Curvine集群
# 使用方法: ansible-playbook uninstall.yml
# 注意：此操作会删除所有Curvine相关文件和配置，请谨慎使用！

- name: Uninstall Curvine Cluster
  hosts: all
  gather_facts: no
  vars:
    curvine_install_dir: /root/dist
  
  tasks:
    - name: Confirm uninstallation
      pause:
        prompt: |
          ========================================
          警告: 此操作将完全卸载Curvine集群！
          
          将执行以下操作:
          1. 停止所有Curvine服务
          2. 禁用服务自启动
          3. 删除systemd服务文件
          4. 删除安装目录
          5. 清理环境变量
          
          按 Ctrl+C 取消，按回车键继续...
          ========================================
      run_once: true
      delegate_to: localhost

    - name: Stop curvine-fuse service
      systemd:
        name: curvine-fuse
        state: stopped
      ignore_errors: yes

    - name: Stop curvine-worker service
      systemd:
        name: curvine-worker
        state: stopped
      ignore_errors: yes

    - name: Stop curvine-master service (master nodes only)
      systemd:
        name: curvine-master
        state: stopped
      ignore_errors: yes
      when: "'master' in group_names"

    - name: Disable curvine-fuse service
      systemd:
        name: curvine-fuse
        enabled: no
      ignore_errors: yes

    - name: Disable curvine-worker service
      systemd:
        name: curvine-worker
        enabled: no
      ignore_errors: yes

    - name: Disable curvine-master service (master nodes only)
      systemd:
        name: curvine-master
        enabled: no
      ignore_errors: yes
      when: "'master' in group_names"

    - name: Remove systemd service files
      file:
        path: "/etc/systemd/system/{{ item }}.service"
        state: absent
      loop:
        - curvine-master
        - curvine-worker
        - curvine-fuse
      ignore_errors: yes

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Unmount FUSE mount points
      shell: |
        if mountpoint -q /curvine-fuse; then
          umount /curvine-fuse
        fi
      ignore_errors: yes

    - name: Remove installation directory
      file:
        path: "{{ curvine_install_dir }}"
        state: absent

    - name: Remove distribution packages
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /root/dist.tar.gz
        - /root/dist1.tar.gz
      ignore_errors: yes

    - name: Remove CURVINE_MASTER_HOSTNAME from /etc/profile
      lineinfile:
        path: /etc/profile
        regexp: '^export CURVINE_MASTER_HOSTNAME='
        state: absent
        backup: yes

    - name: Clean up old profile backups (keep last 3)
      shell: |
        cd /etc
        ls -t profile.* 2>/dev/null | tail -n +4 | xargs -r rm -f
      ignore_errors: yes

    - name: Display uninstall completion message
      debug:
        msg: "节点 {{ inventory_hostname }} 卸载完成"

- name: Uninstall Summary
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Display summary
      debug:
        msg: |
          ========================================
          Curvine集群卸载完成！
          
          已清理的内容:
          - 所有Curvine服务
          - systemd服务文件
          - 安装目录 (/root/dist)
          - 安装包文件
          - 环境变量配置
          
          注意: 数据目录未被删除，如需清理请手动删除
          ========================================

