# ç£ç›˜æ ¼å¼åŒ–å’ŒæŒ‚è½½åŠŸèƒ½è¯´æ˜

## âœ¨ åŠŸèƒ½æ¦‚è¿°

åœ¨éƒ¨ç½²Curvineé›†ç¾¤å‰ï¼Œè‡ªåŠ¨æ£€æµ‹æ‰€æœ‰èŠ‚ç‚¹çš„æœªæ ¼å¼åŒ–ç£ç›˜ï¼Œå¹¶æä¾›ä¸€é”®æ ¼å¼åŒ–å’ŒæŒ‚è½½åŠŸèƒ½ã€‚

## ğŸ” æ£€æµ‹é€»è¾‘

### æœªæ ¼å¼åŒ–ç£ç›˜çš„åˆ¤æ–­æ¡ä»¶ï¼ˆéœ€åŒæ—¶æ»¡è¶³ï¼‰ï¼š

1. âœ… lsblkä¸­TYPEä¸º`disk`
2. âœ… lsblkä¸­MOUNTPOINTä¸ºç©º
3. âœ… æ²¡æœ‰å­åˆ†åŒºï¼ˆæ²¡æœ‰TYPEä¸º`part`çš„å­è®¾å¤‡ï¼‰
4. âœ… df -hä¸­çœ‹ä¸åˆ°è¯¥ç£ç›˜
5. âœ… å­è®¾å¤‡ä¹Ÿæœªè¢«æŒ‚è½½

### æ£€æµ‹ç¤ºä¾‹

**lsblkè¾“å‡º**ï¼š
```
NAME   SIZE TYPE MOUNTPOINT
vda     50G disk 
â”œâ”€vda1   1M part 
â””â”€vda2  50G part /
vdb     70G disk /data        â† å·²æŒ‚è½½ï¼Œè·³è¿‡
vdc    100G disk              â† æœªæ ¼å¼åŒ–ï¼Œä¼šè¢«æ£€æµ‹åˆ°
vdd    200G disk              â† æœªæ ¼å¼åŒ–ï¼Œä¼šè¢«æ£€æµ‹åˆ°
```

**æ£€æµ‹ç»“æœ**ï¼š
- `vda` - æœ‰å­åˆ†åŒºï¼Œè·³è¿‡
- `vdb` - å·²æŒ‚è½½ï¼Œè·³è¿‡
- `vdc` - âœ“ æœªæ ¼å¼åŒ–ï¼Œæ£€æµ‹åˆ°
- `vdd` - âœ“ æœªæ ¼å¼åŒ–ï¼Œæ£€æµ‹åˆ°

## ğŸš€ ä½¿ç”¨æµç¨‹

### é›†æˆåœ¨éƒ¨ç½²è„šæœ¬ä¸­

```bash
./deploy_all.sh

# æµç¨‹ï¼š
# 1. æ£€æµ‹èŠ‚ç‚¹è¿æ¥
# 2. SSHå…å¯†é…ç½®
# 3. æ”¶é›†èŠ‚ç‚¹ä¿¡æ¯ï¼ˆç½‘ç»œ+ç£ç›˜ï¼‰
#    â””â”€ ç”¨æˆ·ç¡®è®¤ Y
# 4. æ£€æµ‹æœªæ ¼å¼åŒ–ç£ç›˜
#    â””â”€ æ˜¾ç¤ºæ‰€æœ‰æœªæ ¼å¼åŒ–ç£ç›˜
#    â””â”€ ç”¨æˆ·ç¡®è®¤æ˜¯å¦æ ¼å¼åŒ– Y/n
# 5. æ‰§è¡Œæ ¼å¼åŒ–å’ŒæŒ‚è½½ï¼ˆå¦‚æœç”¨æˆ·é€‰æ‹©Yï¼‰
#    â””â”€ æ ¼å¼åŒ–ä¸ºext4
#    â””â”€ æŒ‚è½½åˆ° /datads1, /datads2, ...
#    â””â”€ æ·»åŠ åˆ° /etc/fstab
#    â””â”€ æ˜¾ç¤ºæ ¼å¼åŒ–åçš„ç£ç›˜ä¿¡æ¯
#    â””â”€ ç”¨æˆ·ç¡®è®¤ç»“æœ Y
# 6. å¼€å§‹éƒ¨ç½²Curvine
```

## ğŸ“‹ æ˜¾ç¤ºæ ¼å¼

### æ£€æµ‹åˆ°æœªæ ¼å¼åŒ–ç£ç›˜æ—¶ï¼š

```
========================================
å‘ç°æœªæ ¼å¼åŒ–çš„ç£ç›˜ï¼š
========================================

èŠ‚ç‚¹ 10.200.3.14:
  - /dev/vdc -> å°†æŒ‚è½½åˆ° /datads1
  - /dev/vdd -> å°†æŒ‚è½½åˆ° /datads2

èŠ‚ç‚¹ 10.200.3.15:
  - /dev/vdc -> å°†æŒ‚è½½åˆ° /datads1

========================================
æ˜¯å¦æ ¼å¼åŒ–å¹¶æŒ‚è½½è¿™äº›ç£ç›˜ï¼Ÿ(Y/nï¼Œè¾“å…¥nè·³è¿‡):
```

### æ ¼å¼åŒ–è¿‡ç¨‹ï¼š

```
========================================
å¼€å§‹æ ¼å¼åŒ–å’ŒæŒ‚è½½ç£ç›˜...
========================================
å¤„ç†èŠ‚ç‚¹ 10.200.3.14...
  æ ¼å¼åŒ– /dev/vdc...
  åˆ›å»ºæŒ‚è½½ç‚¹ /datads1...
  æŒ‚è½½ /dev/vdc åˆ° /datads1...
  æ·»åŠ åˆ° /etc/fstab...
  âœ“ /dev/vdc æ ¼å¼åŒ–å¹¶æŒ‚è½½åˆ° /datads1 å®Œæˆ
  
  æ ¼å¼åŒ– /dev/vdd...
  åˆ›å»ºæŒ‚è½½ç‚¹ /datads2...
  æŒ‚è½½ /dev/vdd åˆ° /datads2...
  æ·»åŠ åˆ° /etc/fstab...
  âœ“ /dev/vdd æ ¼å¼åŒ–å¹¶æŒ‚è½½åˆ° /datads2 å®Œæˆ
```

### æ ¼å¼åŒ–åéªŒè¯ï¼š

```
========================================
æ ¼å¼åŒ–å’ŒæŒ‚è½½å®Œæˆï¼Œæ˜¾ç¤ºæ›´æ–°åçš„ç£ç›˜ä¿¡æ¯ï¼š
========================================

================================================================================
èŠ‚ç‚¹: 10.200.3.14 (Master) - æ›´æ–°åçš„ç£ç›˜ä¿¡æ¯
================================================================================

lsblk:
  NAME   SIZE TYPE MOUNTPOINT
  vda     50G disk 
  â”œâ”€vda1   1M part 
  â””â”€vda2  50G part /
  vdb     70G disk /data
  vdc    100G disk /datads1    â† æ–°æŒ‚è½½
  vdd    200G disk /datads2    â† æ–°æŒ‚è½½

df -h:
  Filesystem     Size  Used Avail Use% Mounted on
  /dev/vda2       50G   13G   35G  27% /
  /dev/vdb        69G  588K   65G   1% /data
  /dev/vdc       100G   60M   95G   1% /datads1   â† æ–°æŒ‚è½½
  /dev/vdd       200G   60M  190G   1% /datads2   â† æ–°æŒ‚è½½

========================================
è¯·ç¡®è®¤ç£ç›˜æ ¼å¼åŒ–å’ŒæŒ‚è½½ç»“æœï¼Œè¾“å…¥ Y ç»§ç»­éƒ¨ç½²ï¼Œè¾“å…¥ N å–æ¶ˆ:
```

## âš™ï¸ æŠ€æœ¯ç»†èŠ‚

### æ ¼å¼åŒ–å‘½ä»¤
```bash
mkfs.ext4 -F /dev/{disk}
```
- `-F` å‚æ•°ï¼šå¼ºåˆ¶æ ¼å¼åŒ–ï¼Œä¸è¯¢é—®ç¡®è®¤
- æ–‡ä»¶ç³»ç»Ÿï¼šext4

### æŒ‚è½½ç‚¹å‘½åè§„åˆ™
- ç¬¬1ä¸ªç£ç›˜ï¼š`/datads1`
- ç¬¬2ä¸ªç£ç›˜ï¼š`/datads2`
- ç¬¬3ä¸ªç£ç›˜ï¼š`/datads3`
- ä¾æ­¤ç±»æ¨...

### fstabé…ç½®
è‡ªåŠ¨æ·»åŠ åˆ° `/etc/fstab` å®ç°å¼€æœºè‡ªåŠ¨æŒ‚è½½ï¼š
```
/dev/vdc /datads1 ext4 defaults 0 0
/dev/vdd /datads2 ext4 defaults 0 0
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

1. **å¤šæ¬¡ç¡®è®¤**ï¼š
   - ç¬¬ä¸€æ¬¡ï¼šæ˜¾ç¤ºæœªæ ¼å¼åŒ–ç£ç›˜åç¡®è®¤
   - ç¬¬äºŒæ¬¡ï¼šæ ¼å¼åŒ–å®Œæˆåç¡®è®¤ç»“æœ

2. **å®Œæ•´æ—¥å¿—**ï¼šæ‰€æœ‰æ“ä½œè®°å½•åˆ° `deploy.log`

3. **å¯è·³è¿‡**ï¼šè¾“å…¥ `n` å¯ä»¥è·³è¿‡æ ¼å¼åŒ–ï¼Œç›´æ¥éƒ¨ç½²

4. **éªŒè¯**ï¼šæ ¼å¼åŒ–åæ˜¾ç¤ºlsblkå’Œdf -héªŒè¯ç»“æœ

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®ä¸¢å¤±é£é™©**ï¼š
   - æ ¼å¼åŒ–ä¼šæ¸…ç©ºç£ç›˜æ‰€æœ‰æ•°æ®
   - è¯·åŠ¡å¿…ç¡®è®¤ç£ç›˜æ˜¯æ–°ç£ç›˜æˆ–å¯ä»¥æ¸…ç©ºçš„ç£ç›˜
   - å»ºè®®åœ¨æ ¼å¼åŒ–å‰æ‰‹åŠ¨æ£€æŸ¥ç£ç›˜å†…å®¹

2. **æ£€æµ‹é€»è¾‘**ï¼š
   - åªæ£€æµ‹å®Œå…¨æœªä½¿ç”¨çš„ç£ç›˜
   - æœ‰åˆ†åŒºæˆ–å·²æŒ‚è½½çš„ç£ç›˜ä¸ä¼šè¢«æ£€æµ‹
   - ç¡®ä¿ä¸ä¼šè¯¯æ ¼å¼åŒ–æ­£åœ¨ä½¿ç”¨çš„ç£ç›˜

3. **æŒ‚è½½ç‚¹å†²çª**ï¼š
   - å¦‚æœ `/datads1` ç­‰ç›®å½•å·²å­˜åœ¨ï¼Œä¼šè¦†ç›–
   - å»ºè®®åœ¨å…¨æ–°ç³»ç»Ÿä¸Šä½¿ç”¨

4. **æƒé™è¦æ±‚**ï¼š
   - éœ€è¦rootæƒé™
   - æ ¼å¼åŒ–å’ŒæŒ‚è½½éƒ½æ˜¯ç³»ç»Ÿçº§æ“ä½œ

## ğŸ› ï¸ æ‰‹åŠ¨æ ¼å¼åŒ–ï¼ˆå¦‚ä¸ä½¿ç”¨è‡ªåŠ¨åŒ–ï¼‰

å¦‚æœä¸æƒ³ä½¿ç”¨è‡ªåŠ¨æ ¼å¼åŒ–åŠŸèƒ½ï¼š

```bash
# åœ¨ç›®æ ‡èŠ‚ç‚¹ä¸Šæ‰‹åŠ¨æ‰§è¡Œ
# 1. æŸ¥çœ‹æœªæ ¼å¼åŒ–çš„ç£ç›˜
lsblk

# 2. æ ¼å¼åŒ–
mkfs.ext4 -F /dev/vdc

# 3. åˆ›å»ºæŒ‚è½½ç‚¹
mkdir -p /datads1

# 4. æŒ‚è½½
mount /dev/vdc /datads1

# 5. æ·»åŠ åˆ°fstab
echo '/dev/vdc /datads1 ext4 defaults 0 0' >> /etc/fstab

# 6. éªŒè¯
df -h | grep vdc
lsblk | grep vdc
```

## ğŸ“Š ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šå…¨æ–°æœåŠ¡å™¨
- æœåŠ¡å™¨åˆšæ·»åŠ äº†æ–°ç£ç›˜
- ç£ç›˜å®Œå…¨æœªä½¿ç”¨
- éœ€è¦å¿«é€Ÿæ ¼å¼åŒ–å’ŒæŒ‚è½½ç”¨äºCurvineæ•°æ®å­˜å‚¨

### åœºæ™¯2ï¼šæµ‹è¯•ç¯å¢ƒ
- é¢‘ç¹é‡ç½®ç¯å¢ƒ
- éœ€è¦è‡ªåŠ¨åˆå§‹åŒ–ç£ç›˜
- å‡å°‘æ‰‹åŠ¨æ“ä½œ

### åœºæ™¯3ï¼šæ‰¹é‡éƒ¨ç½²
- å¤šå°æœåŠ¡å™¨åŒæ—¶éƒ¨ç½²
- ç£ç›˜é…ç½®ç›¸åŒ
- ä¸€é”®å®Œæˆæ‰€æœ‰åˆå§‹åŒ–

## ğŸ”§ è‡ªå®šä¹‰æŒ‚è½½ç‚¹

å¦‚æœéœ€è¦è‡ªå®šä¹‰æŒ‚è½½ç‚¹åç§°ï¼Œä¿®æ”¹ `deploy_all.sh`ï¼š

```bash
# æŸ¥æ‰¾è¿™ä¸€è¡Œï¼š
mountpoint="/datads${disk_num}"

# ä¿®æ”¹ä¸ºï¼š
mountpoint="/data/disk${disk_num}"  # æˆ–å…¶ä»–è·¯å¾„
```

## ğŸ“ æ—¥å¿—è®°å½•

æ‰€æœ‰æ ¼å¼åŒ–å’ŒæŒ‚è½½æ“ä½œéƒ½ä¼šè®°å½•åˆ° `deploy.log`ï¼š

```
[2025-12-17 14:15:30] æ ¼å¼åŒ– /dev/vdc...
[2025-12-17 14:15:35] åˆ›å»ºæŒ‚è½½ç‚¹ /datads1...
[2025-12-17 14:15:36] æŒ‚è½½ /dev/vdc åˆ° /datads1...
[2025-12-17 14:15:37] æ·»åŠ åˆ° /etc/fstab...
[2025-12-17 14:15:37] âœ“ /dev/vdc æ ¼å¼åŒ–å¹¶æŒ‚è½½åˆ° /datads1 å®Œæˆ
```

## ğŸ†˜ æ•…éšœæ’æŸ¥

### æ ¼å¼åŒ–å¤±è´¥

```bash
# æ£€æŸ¥ç£ç›˜çŠ¶æ€
ansible <host> -m shell -a "lsblk /dev/vdc"

# æ£€æŸ¥æ˜¯å¦è¢«å ç”¨
ansible <host> -m shell -a "lsof | grep vdc"

# æ‰‹åŠ¨æ ¼å¼åŒ–
ansible <host> -m shell -a "mkfs.ext4 -F /dev/vdc"
```

### æŒ‚è½½å¤±è´¥

```bash
# æ£€æŸ¥æŒ‚è½½ç‚¹
ansible <host> -m shell -a "ls -la /datads1"

# æ£€æŸ¥fstab
ansible <host> -m shell -a "cat /etc/fstab"

# æ‰‹åŠ¨æŒ‚è½½
ansible <host> -m shell -a "mount /dev/vdc /datads1"
```

### å¸è½½ç£ç›˜

å¦‚æœéœ€è¦å¸è½½ï¼š

```bash
# å¸è½½
ansible <host> -m shell -a "umount /datads1"

# ä»fstabä¸­ç§»é™¤
ansible <host> -m shell -a "sed -i '/datads1/d' /etc/fstab"
```

## âœ… æœ€ä½³å®è·µ

1. **æ ¼å¼åŒ–å‰å¤‡ä»½**ï¼šç¡®ä¿ç£ç›˜ä¸Šæ²¡æœ‰é‡è¦æ•°æ®

2. **éªŒè¯ç£ç›˜**ï¼šåœ¨ç¡®è®¤æ ¼å¼åŒ–å‰ï¼Œæ‰‹åŠ¨æ£€æŸ¥ `lsblk` å’Œ `df -h` è¾“å‡º

3. **ä½¿ç”¨æ ‡ç­¾**ï¼šæ ¼å¼åŒ–æ—¶å¯ä»¥æ·»åŠ æ ‡ç­¾æ–¹ä¾¿ç®¡ç†
   ```bash
   mkfs.ext4 -F -L curvine-data1 /dev/vdc
   ```

4. **ç›‘æ§ç©ºé—´**ï¼šå®šæœŸæ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
   ```bash
   ansible all -m shell -a "df -h | grep datads"
   ```

5. **å¼€æœºéªŒè¯**ï¼šé‡å¯åéªŒè¯ç£ç›˜è‡ªåŠ¨æŒ‚è½½
   ```bash
   ansible all -m shell -a "mount | grep datads"
   ```

