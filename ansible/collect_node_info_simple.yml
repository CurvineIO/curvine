---
# 收集所有节点的IP和磁盘信息（简化版）

- name: Collect Node Information
  hosts: all
  gather_facts: yes
  any_errors_fatal: false
  ignore_unreachable: yes
  
  tasks:
    - name: Get network interfaces (eth, en, bond)
      shell: |
        ip addr show | grep -E '^[0-9]+: (eth|en|bond)' -A 5 | \
        awk '/^[0-9]+:/{iface=$2; gsub(/:/, "", iface)} /inet /{print iface":"$2}' | \
        sed 's|/[0-9]*||'
      register: network_info
      ignore_errors: yes

    - name: Get lsblk information
      shell: lsblk -o NAME,SIZE,TYPE,MOUNTPOINT
      register: lsblk_info
      ignore_errors: yes

    - name: Get disk usage (only /dev devices)
      shell: df -h | grep '^/dev'
      register: df_info
      ignore_errors: yes

    - name: Display node information
      debug:
        msg: |
          ================================================================================
          节点: {{ inventory_hostname }} ({{ 'Master' if 'master' in group_names else 'Worker' }})
          ================================================================================
          
          网络信息:
          {{ network_info.stdout }}
          
          磁盘信息 (lsblk):
          {{ lsblk_info.stdout }}
          
          磁盘使用情况 (df -h):
          {{ df_info.stdout }}
          
          ================================================================================

    - name: Write node info to local file
      local_action:
        module: shell
        _raw_params: |
          echo "================================================================================" >> node_info_summary.txt
          echo "节点: {{ inventory_hostname }} ({{ 'Master' if 'master' in group_names else 'Worker' }})" >> node_info_summary.txt
          echo "================================================================================" >> node_info_summary.txt
          echo "" >> node_info_summary.txt
          echo "网络信息:" >> node_info_summary.txt
          echo "{{ network_info.stdout }}" | sed 's/^/  /' >> node_info_summary.txt
          echo "" >> node_info_summary.txt
          echo "磁盘信息 (lsblk):" >> node_info_summary.txt
          echo "{{ lsblk_info.stdout }}" | sed 's/^/  /' >> node_info_summary.txt
          echo "" >> node_info_summary.txt
          echo "磁盘使用情况 (df -h):" >> node_info_summary.txt
          echo "{{ df_info.stdout }}" | sed 's/^/  /' >> node_info_summary.txt
          echo "" >> node_info_summary.txt
      when: network_info.rc is defined and network_info.rc == 0

