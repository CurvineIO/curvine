---
# 收集所有节点的IP和磁盘信息
# 使用方法: ansible-playbook collect_node_info.yml

- name: Collect Node Information
  hosts: all
  gather_facts: yes
  any_errors_fatal: false
  ignore_unreachable: yes
  
  tasks:
    - name: Get network interfaces (eth, en, bond)
      shell: |
        ip addr show | grep -E '^[0-9]+: (eth|en|bond)' -A 5 | \
        awk '/^[0-9]+:/{iface=$2; gsub(/:/, "", iface)} /inet /{print iface":"$2}' | \
        sed 's|/[0-9]*||'
      register: network_info
      ignore_errors: yes

    - name: Get lsblk information
      shell: lsblk -o NAME,SIZE,TYPE,MOUNTPOINT
      register: lsblk_info
      ignore_errors: yes

    - name: Get disk usage (only /dev devices)
      shell: df -h | grep '^/dev'
      register: df_info
      ignore_errors: yes

    - name: Store node information
      set_fact:
        node_info:
          hostname: "{{ inventory_hostname }}"
          group: "{{ 'Master' if 'master' in group_names else 'Worker' }}"
          network: "{{ network_info.stdout_lines | default([]) }}"
          lsblk: "{{ lsblk_info.stdout_lines | default([]) }}"
          disk_usage: "{{ df_info.stdout_lines | default([]) }}"

- name: Display Collected Information
  hosts: localhost
  gather_facts: no
  run_once: true
  
  tasks:
    - name: Collect all node info
      set_fact:
        all_nodes_info: "{{ groups['all'] | map('extract', hostvars) | list }}"

    - name: Build summary lines
      set_fact:
        summary_lines: []

    - name: Add header
      set_fact:
        summary_lines: "{{ summary_lines + ['================================================================================'] }}"

    - name: Add title
      set_fact:
        summary_lines: "{{ summary_lines + ['Curvine集群节点信息汇总'] }}"

    - name: Add timestamp
      set_fact:
        summary_lines: "{{ summary_lines + ['收集时间: ' + ansible_date_time.iso8601] }}"

    - name: Add separator
      set_fact:
        summary_lines: "{{ summary_lines + ['================================================================================', ''] }}"

    - name: Build node information
      set_fact:
        summary_lines: "{{ summary_lines + ['', '================================================================================', '节点: ' + item.inventory_hostname + ' (' + item.node_info.group + ')', '================================================================================', '', '网络信息:'] + item.node_info.network | map('regex_replace', '^', '  ') | list + ['', '磁盘信息 (lsblk):'] + item.node_info.lsblk | map('regex_replace', '^', '  ') | list + ['', '磁盘使用情况 (df -h):'] + item.node_info.disk_usage | map('regex_replace', '^', '  ') | list }}"
      loop: "{{ all_nodes_info }}"
      when: item.node_info is defined

    - name: Display information for each node
      debug:
        msg: |
          ================================================================================
          节点: {{ item.inventory_hostname }} ({{ item.node_info.group if item.node_info is defined else 'Unknown' }})
          ================================================================================
          
          网络信息:
          {% if item.node_info is defined and item.node_info.network %}
          {% for net in item.node_info.network %}
            {{ net }}
          {% endfor %}
          {% else %}
            无网络信息
          {% endif %}
          
          磁盘信息 (lsblk):
          {% if item.node_info is defined and item.node_info.lsblk %}
          {% for line in item.node_info.lsblk %}
            {{ line }}
          {% endfor %}
          {% else %}
            无lsblk信息
          {% endif %}
          
          磁盘使用情况 (df -h):
          {% if item.node_info is defined and item.node_info.disk_usage %}
          {% for line in item.node_info.disk_usage %}
            {{ line }}
          {% endfor %}
          {% else %}
            无磁盘使用信息
          {% endif %}
          
      loop: "{{ all_nodes_info }}"
      when: item.node_info is defined

    - name: Save to summary file
      local_action:
        module: copy
        content: "{{ summary_lines | join('\n') }}"
        dest: "./node_info_summary.txt"

    - name: Display summary location
      debug:
        msg: |
          ========================================
          节点信息已保存到当前目录: node_info_summary.txt
          ========================================

