# Curvineé›†ç¾¤è‡ªåŠ¨åŒ–éƒ¨ç½² - å®Œæ•´åŠŸèƒ½è¯´æ˜

## ğŸ¯ å®Œæ•´éƒ¨ç½²æµç¨‹ï¼ˆv1.8.1ï¼‰

```bash
./deploy_all.sh
```

### æµç¨‹å›¾

```
1. æ£€æŸ¥å¿…è¦æ–‡ä»¶
   â”œâ”€ hosts.ini
   â”œâ”€ /root/dist.tar.gz
   â””â”€ /root/dist1.tar.gz

2. å¿«é€Ÿæ£€æµ‹èŠ‚ç‚¹è¿æ¥ï¼ˆ3ç§’è¶…æ—¶ï¼‰
   â”œâ”€ MasterèŠ‚ç‚¹æ£€æµ‹
   â”œâ”€ WorkerèŠ‚ç‚¹æ£€æµ‹
   â””â”€ è¿æ¥å¤±è´¥çš„èŠ‚ç‚¹è‡ªåŠ¨è·³è¿‡

3. SSHå…å¯†ç™»å½•é…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
   â”œâ”€ ç”ŸæˆSSHå¯†é’¥å¯¹
   â”œâ”€ åˆ†å‘å…¬é’¥åˆ°æ‰€æœ‰èŠ‚ç‚¹
   â””â”€ unreachableèŠ‚ç‚¹è·³è¿‡

4. æ”¶é›†èŠ‚ç‚¹ä¿¡æ¯
   â”œâ”€ ç½‘ç»œä¿¡æ¯ï¼ˆethã€enã€bondç½‘å¡IPï¼‰
   â”œâ”€ ç£ç›˜å¸ƒå±€ï¼ˆlsblkï¼‰
   â”œâ”€ ç£ç›˜ä½¿ç”¨ï¼ˆdf -hï¼Œå¸¦è¡¨å¤´ï¼‰
   â”œâ”€ ä¿å­˜åˆ° node_info_summary.txt
   â”œâ”€ æ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
   â””â”€ âœ‹ ç”¨æˆ·ç¡®è®¤ Y

5. æ£€æµ‹æœªæ ¼å¼åŒ–ç£ç›˜
   â”œâ”€ æ¡ä»¶1: TYPEä¸ºdisk
   â”œâ”€ æ¡ä»¶2: MOUNTPOINTä¸ºç©º
   â”œâ”€ æ¡ä»¶3: æ²¡æœ‰å­åˆ†åŒº
   â”œâ”€ æ¡ä»¶4: dfä¸­ä¸å­˜åœ¨
   â”œâ”€ æ˜¾ç¤ºæ‰€æœ‰æœªæ ¼å¼åŒ–ç£ç›˜
   â””â”€ âœ‹ ç”¨æˆ·ç¡®è®¤ Y/n

6. æ ¼å¼åŒ–å’ŒæŒ‚è½½ï¼ˆå¦‚æœæ­¥éª¤5é€‰æ‹©Yï¼‰
   â”œâ”€ mkfs.ext4 -F /dev/{ç£ç›˜}
   â”œâ”€ mkdiråˆ›å»ºæŒ‚è½½ç‚¹ï¼ˆ/datads1, /datads2...ï¼‰
   â”œâ”€ mountæŒ‚è½½ç£ç›˜
   â”œâ”€ æ·»åŠ åˆ°/etc/fstab
   â”œâ”€ æ˜¾ç¤ºæ ¼å¼åŒ–åçš„lsblkå’Œdf -h
   â””â”€ âœ‹ ç”¨æˆ·ç¡®è®¤ç»“æœ Y

7. ç¡®è®¤éƒ¨ç½²
   â””â”€ âœ‹ ç”¨æˆ·ç¡®è®¤ y

8. æ‰§è¡Œéƒ¨ç½²
   â”œâ”€ é…ç½®ç¯å¢ƒå˜é‡ï¼ˆCURVINE_MASTER_HOSTNAMEï¼‰
   â”œâ”€ åˆ†å‘å®‰è£…åŒ…
   â”œâ”€ è§£å‹å¹¶å¤„ç†dist/dist1ç›®å½•
   â”œâ”€ é…ç½®data_dirï¼ˆå¦‚æœæ²¡æœ‰æ ¼å¼åŒ–æ–°ç£ç›˜ï¼‰
   â””â”€ åˆ›å»ºsystemdæœåŠ¡

9. æ›´æ–°é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœæœ‰æ–°æ ¼å¼åŒ–çš„ç£ç›˜ï¼‰ğŸ†•
   â”œâ”€ MasterèŠ‚ç‚¹æ›´æ–°ï¼š
   â”‚  â”œâ”€ meta_dir = "{ç¬¬ä¸€ä¸ªæŒ‚è½½ç‚¹}/meta"
   â”‚  â”œâ”€ journal_dir = "{ç¬¬ä¸€ä¸ªæŒ‚è½½ç‚¹}/journal"
   â”‚  â””â”€ data_dir = ["{æ‰€æœ‰æŒ‚è½½ç‚¹}/data", ...]
   â”œâ”€ WorkerèŠ‚ç‚¹æ›´æ–°ï¼š
   â”‚  â””â”€ data_dir = ["{æ‰€æœ‰æŒ‚è½½ç‚¹}/data", ...]
   â”œâ”€ æ˜¾ç¤ºæ¯ä¸ªèŠ‚ç‚¹çš„æ›´æ–°åé…ç½®
   â””â”€ âœ‹ ç”¨æˆ·ç¡®è®¤ Y

10. å¯åŠ¨æœåŠ¡
    â”œâ”€ MasterèŠ‚ç‚¹ï¼šmaster â†’ worker â†’ fuse
    â”œâ”€ WorkerèŠ‚ç‚¹ï¼šworker â†’ fuse
    â””â”€ æ˜¾ç¤ºæœåŠ¡çŠ¶æ€

11. å®Œæˆ
    â”œâ”€ æ˜¾ç¤ºéƒ¨ç½²æ±‡æ€»
    â”œâ”€ æ—¥å¿—ä¿å­˜åˆ° deploy.log
    â””â”€ èŠ‚ç‚¹ä¿¡æ¯ä¿å­˜åˆ° node_info_summary.txt
```

## ğŸ“Š é…ç½®æ–‡ä»¶æ›´æ–°ç¤ºä¾‹

### åœºæ™¯1ï¼šMasterèŠ‚ç‚¹æœ‰1å—æ–°ç£ç›˜

**ç£ç›˜**ï¼švdb â†’ /datads1

**é…ç½®æ›´æ–°**ï¼š
```toml
# æ›´æ–°å‰
meta_dir = "/data/meta"
journal_dir = "/data/journal"
data_dir = ["/data/data"]

# æ›´æ–°å
meta_dir = "/datads1/meta"
journal_dir = "/datads1/journal"
data_dir = ["/datads1/data"]
```

### åœºæ™¯2ï¼šMasterèŠ‚ç‚¹æœ‰2å—æ–°ç£ç›˜

**ç£ç›˜**ï¼švdb â†’ /datads1, vdc â†’ /datads2

**é…ç½®æ›´æ–°**ï¼š
```toml
# æ›´æ–°å‰
meta_dir = "/data/meta"
journal_dir = "/data/journal"
data_dir = ["/data/data"]

# æ›´æ–°å
meta_dir = "/datads1/meta"        # ä½¿ç”¨ç¬¬ä¸€ä¸ªæŒ‚è½½ç‚¹
journal_dir = "/datads1/journal"  # ä½¿ç”¨ç¬¬ä¸€ä¸ªæŒ‚è½½ç‚¹
data_dir = ["/datads1/data", "/datads2/data"]  # ä½¿ç”¨æ‰€æœ‰æŒ‚è½½ç‚¹
```

### åœºæ™¯3ï¼šWorkerèŠ‚ç‚¹æœ‰1å—æ–°ç£ç›˜

**ç£ç›˜**ï¼švdb â†’ /datads1

**é…ç½®æ›´æ–°**ï¼š
```toml
# æ›´æ–°å‰
data_dir = ["/data/data"]

# æ›´æ–°å
data_dir = ["/datads1/data"]
```

### åœºæ™¯4ï¼šWorkerèŠ‚ç‚¹æœ‰3å—æ–°ç£ç›˜

**ç£ç›˜**ï¼švdb â†’ /datads1, vdc â†’ /datads2, vdd â†’ /datads3

**é…ç½®æ›´æ–°**ï¼š
```toml
# æ›´æ–°å‰
data_dir = ["/data/data"]

# æ›´æ–°å
data_dir = ["/datads1/data", "/datads2/data", "/datads3/data"]
```

## ğŸ”’ å®‰å…¨ä¿æŠ¤

### 1. å¤šå±‚æ£€æµ‹ä¿æŠ¤
- âœ… æœ‰åˆ†åŒºçš„ç£ç›˜ä¸ä¼šè¢«æ£€æµ‹ï¼ˆå¦‚nvme0n1æœ‰p1-p4åˆ†åŒºï¼‰
- âœ… å·²æŒ‚è½½çš„ç£ç›˜ä¸ä¼šè¢«æ£€æµ‹ï¼ˆå¦‚vdbæŒ‚è½½åˆ°/dataï¼‰
- âœ… ä¸¥æ ¼çš„ç£ç›˜åè¿‡æ»¤ï¼ˆåªåŒ¹é…sdã€vdã€nvmeã€xvdç­‰ï¼‰
- âœ… é”™è¯¯ä¿¡æ¯ä¸ä¼šè¢«å½“ä½œç£ç›˜å

### 2. å¤šæ¬¡ç”¨æˆ·ç¡®è®¤
- âœ‹ èŠ‚ç‚¹ä¿¡æ¯ç¡®è®¤
- âœ‹ æ ¼å¼åŒ–å‰ç¡®è®¤
- âœ‹ æ ¼å¼åŒ–åç»“æœç¡®è®¤
- âœ‹ é…ç½®æ›´æ–°åç¡®è®¤
- âœ‹ æœ€ç»ˆéƒ¨ç½²ç¡®è®¤

### 3. å®Œæ•´å¤‡ä»½
- ğŸ“ é…ç½®æ–‡ä»¶è‡ªåŠ¨å¤‡ä»½ä¸º `.bak`
- ğŸ“ æ‰€æœ‰æ“ä½œè®°å½•åˆ° deploy.log
- ğŸ“ å¯ä»¥å›æ»šå’Œå®¡è®¡

## âš ï¸ é‡è¦æç¤º

### å¯¹äºæ‚¨çš„ç¯å¢ƒï¼ˆ10.200.3.12ï¼‰

**ç£ç›˜çŠ¶æ€**ï¼š
```
vda - æœ‰åˆ†åŒºvda1ã€vda2ï¼Œvda2æŒ‚è½½åˆ°/    â†’ âœ… ä¸ä¼šè¢«æ ¼å¼åŒ–
vdb - æ— åˆ†åŒºï¼Œæ— æŒ‚è½½ç‚¹                  â†’ âœ… ä¼šè¢«æ£€æµ‹åˆ°
```

**æ£€æµ‹ç»“æœåº”è¯¥æ˜¯**ï¼š
```
èŠ‚ç‚¹ 10.200.3.12:
  - /dev/vdb -> å°†æŒ‚è½½åˆ° /datads1
```

**æ ¼å¼åŒ–åé…ç½®æ›´æ–°ï¼ˆå‡è®¾10.200.3.12æ˜¯Workerï¼‰**ï¼š
```toml
data_dir = ["/datads1/data"]  # åŸæ¥æ˜¯ ["/data/data"]
```

## ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ | æ¨¡å¼ |
|------|------|------|
| deploy.log | å®Œæ•´éƒ¨ç½²æ—¥å¿— | è¿½åŠ  |
| node_info_summary.txt | èŠ‚ç‚¹ä¿¡æ¯æ±‡æ€» | è¦†ç›– |
| unformatted_disks_info.txt | æœªæ ¼å¼åŒ–ç£ç›˜åˆ—è¡¨ | è¦†ç›– |
| /root/dist/conf/curvine-cluster.toml.bak | é…ç½®æ–‡ä»¶å¤‡ä»½ | è¦†ç›– |

## ğŸ” éªŒè¯

éƒ¨ç½²å®ŒæˆåéªŒè¯ï¼š

```bash
# æŸ¥çœ‹æ—¥å¿—
cat deploy.log | grep "æ ¼å¼åŒ–"
cat deploy.log | grep "é…ç½®æ–‡ä»¶"

# æ£€æŸ¥æŒ‚è½½
ansible all -m shell -a "df -h | grep datads"

# æ£€æŸ¥é…ç½®
ansible all -m shell -a "grep -E 'meta_dir|journal_dir|data_dir' /root/dist/conf/curvine-cluster.toml"

# æ£€æŸ¥fstab
ansible all -m shell -a "grep datads /etc/fstab"

# æ£€æŸ¥æœåŠ¡
ansible-playbook status_services.yml
```

## ğŸ†˜ å¦‚æœå‡ºç°é—®é¢˜

### æ¢å¤é…ç½®æ–‡ä»¶

```bash
# åœ¨ç›®æ ‡èŠ‚ç‚¹ä¸Š
cd /root/dist/conf
cp curvine-cluster.toml.bak curvine-cluster.toml

# é‡å¯æœåŠ¡
systemctl restart curvine-master  # MasterèŠ‚ç‚¹
systemctl restart curvine-worker
systemctl restart curvine-fuse
```

### å¸è½½æŒ‚è½½çš„ç£ç›˜

```bash
# åœæ­¢æœåŠ¡
systemctl stop curvine-*

# å¸è½½
umount /datads1
umount /datads2

# ä»fstabç§»é™¤
sed -i '/datads/d' /etc/fstab
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

- éƒ¨ç½²æ—¥å¿—ï¼š`deploy.log`
- èŠ‚ç‚¹ä¿¡æ¯ï¼š`node_info_summary.txt`
- Curvineæ–‡æ¡£ï¼šhttps://curvineio.github.io

