---
# 修复Worker节点目录路径问题
# 使用场景：dist1.tar.gz解压到了/root/dist1，需要移动到/root/dist
# 使用方法: ansible-playbook fix_dist_path.yml --limit worker

- name: Fix Worker Node Directory Path
  hosts: worker
  gather_facts: no
  vars:
    curvine_install_dir: /root/dist
  
  tasks:
    - name: Stop services
      systemd:
        name: "{{ item }}"
        state: stopped
      loop:
        - curvine-worker
        - curvine-fuse
      ignore_errors: yes

    - name: Check if dist1 directory exists
      stat:
        path: /root/dist1
      register: dist1_exists

    - name: Check if dist directory exists
      stat:
        path: "{{ curvine_install_dir }}"
      register: dist_exists

    - name: Display current situation
      debug:
        msg: |
          当前状态:
          - /root/dist1 {{ '存在' if dist1_exists.stat.exists else '不存在' }}
          - /root/dist {{ '存在' if dist_exists.stat.exists else '不存在' }}

    - name: Backup existing dist if it exists and has files
      shell: |
        if [ -d {{ curvine_install_dir }} ] && [ "$(ls -A {{ curvine_install_dir }})" ]; then
          mv {{ curvine_install_dir }} {{ curvine_install_dir }}.backup.$(date +%Y%m%d_%H%M%S)
          echo "Backed up"
        fi
      register: backup_result
      args:
        executable: /bin/bash

    - name: Display backup result
      debug:
        msg: "{{ backup_result.stdout }}"
      when: backup_result.stdout != ""

    - name: Move dist1 to dist
      shell: mv /root/dist1 {{ curvine_install_dir }}
      when: dist1_exists.stat.exists

    - name: Verify dist directory now exists
      stat:
        path: "{{ curvine_install_dir }}"
      register: dist_final

    - name: Display result
      debug:
        msg: |
          {% if dist_final.stat.exists %}
          ✓ 目录修复成功！{{ curvine_install_dir }} 现在存在
          {% else %}
          ✗ 修复失败！{{ curvine_install_dir }} 仍然不存在
          {% endif %}

    - name: List files in dist
      shell: ls -la {{ curvine_install_dir }}
      register: dist_contents
      when: dist_final.stat.exists

    - name: Display dist contents
      debug:
        msg: "{{ dist_contents.stdout_lines }}"
      when: dist_final.stat.exists

    - name: Check critical files
      stat:
        path: "{{ item }}"
      register: critical_files
      loop:
        - "{{ curvine_install_dir }}/bin/curvine-worker.sh"
        - "{{ curvine_install_dir }}/bin/curvine-fuse.sh"
        - "{{ curvine_install_dir }}/lib/curvine-server"
      when: dist_final.stat.exists

    - name: Display critical files status
      debug:
        msg: "{{ item.item }}: {{ '✓ 存在' if item.stat.exists else '✗ 不存在' }}"
      loop: "{{ critical_files.results }}"
      when: dist_final.stat.exists

    - name: Set execute permissions
      file:
        path: "{{ item }}"
        mode: '0755'
        recurse: yes
      loop:
        - "{{ curvine_install_dir }}/bin"
        - "{{ curvine_install_dir }}/lib"
      when: dist_final.stat.exists

    - name: Reload systemd
      systemd:
        daemon_reload: yes

    - name: Start curvine-worker service
      systemd:
        name: curvine-worker
        state: started
      register: worker_start
      ignore_errors: yes
      when: dist_final.stat.exists

    - name: Start curvine-fuse service
      systemd:
        name: curvine-fuse
        state: started
      register: fuse_start
      ignore_errors: yes
      when: dist_final.stat.exists and not (worker_start.failed | default(false))

    - name: Check service status
      systemd:
        name: "{{ item }}"
      register: service_status
      loop:
        - curvine-worker
        - curvine-fuse
      when: dist_final.stat.exists

    - name: Display final status
      debug:
        msg: |
          ========================================
          Worker节点 {{ inventory_hostname }} 路径修复完成
          ========================================
          
          服务状态:
          - curvine-worker: {{ 'running' if not (worker_start.failed | default(false)) else 'failed' }}
          - curvine-fuse: {{ 'running' if not (fuse_start.failed | default(false)) else 'failed' }}
          
          如果服务仍然失败，请运行:
          ansible-playbook diagnose_worker.yml --limit {{ inventory_hostname }}
      when: dist_final.stat.exists

