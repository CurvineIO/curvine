---
# 诊断Worker节点服务问题
# 使用方法: ansible-playbook diagnose_worker.yml --limit worker

- name: Diagnose Worker Node Issues
  hosts: worker
  gather_facts: no
  vars:
    curvine_install_dir: /root/dist
  
  tasks:
    - name: Check if installation directory exists
      stat:
        path: "{{ curvine_install_dir }}"
      register: install_dir_stat

    - name: Display installation directory status
      debug:
        msg: "安装目录 {{ curvine_install_dir }} {{ '存在' if install_dir_stat.stat.exists else '不存在' }}"

    - name: Check if bin directory exists
      stat:
        path: "{{ curvine_install_dir }}/bin"
      register: bin_dir_stat

    - name: Display bin directory status
      debug:
        msg: "bin目录 {{ curvine_install_dir }}/bin {{ '存在' if bin_dir_stat.stat.exists else '不存在' }}"

    - name: List files in bin directory
      shell: ls -la {{ curvine_install_dir }}/bin/
      register: bin_files
      when: bin_dir_stat.stat.exists
      ignore_errors: yes

    - name: Display bin directory contents
      debug:
        msg: "{{ bin_files.stdout_lines }}"
      when: bin_dir_stat.stat.exists and bin_files is defined

    - name: Check curvine-worker.sh file
      stat:
        path: "{{ curvine_install_dir }}/bin/curvine-worker.sh"
      register: worker_script_stat

    - name: Display worker script status
      debug:
        msg: |
          Worker启动脚本状态:
          - 存在: {{ worker_script_stat.stat.exists }}
          {% if worker_script_stat.stat.exists %}
          - 可执行: {{ worker_script_stat.stat.executable }}
          - 权限: {{ worker_script_stat.stat.mode }}
          - 大小: {{ worker_script_stat.stat.size }} bytes
          {% endif %}

    - name: Check lib directory and curvine-server binary
      stat:
        path: "{{ curvine_install_dir }}/lib/curvine-server"
      register: server_binary_stat

    - name: Display server binary status
      debug:
        msg: |
          curvine-server二进制文件状态:
          - 存在: {{ server_binary_stat.stat.exists }}
          {% if server_binary_stat.stat.exists %}
          - 可执行: {{ server_binary_stat.stat.executable }}
          - 权限: {{ server_binary_stat.stat.mode }}
          - 大小: {{ server_binary_stat.stat.size }} bytes
          {% endif %}

    - name: Check config file
      stat:
        path: "{{ curvine_install_dir }}/conf/curvine-cluster.toml"
      register: config_stat

    - name: Display config file status
      debug:
        msg: "配置文件 {{ curvine_install_dir }}/conf/curvine-cluster.toml {{ '存在' if config_stat.stat.exists else '不存在' }}"

    - name: Try to execute worker script manually
      shell: |
        cd {{ curvine_install_dir }}
        bash -x bin/curvine-worker.sh start 2>&1 || true
      register: manual_start
      when: worker_script_stat.stat.exists

    - name: Display manual execution result
      debug:
        msg: "{{ manual_start.stdout_lines }}"
      when: manual_start is defined

    - name: Check systemd service file
      shell: cat /etc/systemd/system/curvine-worker.service
      register: service_file

    - name: Display service file content
      debug:
        msg: "{{ service_file.stdout_lines }}"

    - name: Check journalctl logs
      shell: journalctl -u curvine-worker -n 50 --no-pager
      register: journal_logs
      ignore_errors: yes

    - name: Display journal logs
      debug:
        msg: "{{ journal_logs.stdout_lines }}"
      when: journal_logs is defined

